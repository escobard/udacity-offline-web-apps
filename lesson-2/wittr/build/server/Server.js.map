{"version":3,"sources":["Server.js"],"names":[],"mappings":"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","file":"Server.js","sourcesContent":["import express from 'express';\r\nimport zlib from 'zlib';\r\nimport fs from 'fs';\r\nimport os from 'os';\r\nimport compression from 'compression';\r\nimport {Server as WebSocketServer} from 'ws';\r\nimport http from 'http';\r\nimport url from 'url';\r\nimport net from 'net';\r\nimport Throttle from 'throttle';\r\nimport random from 'lodash/number/random';\r\nimport indexTemplate from './templates/index';\r\nimport postsTemplate from './templates/posts';\r\nimport postTemplate from './templates/post';\r\nimport remoteExecutorTemplate from './templates/remote-executor';\r\nimport idbTestTemplate from './templates/idb-test';\r\nimport {generateReady, generateMessage} from './generateMessage';\r\n\r\nconst maxMessages = 30;\r\n\r\nconst compressor = compression({\r\n  flush: zlib.Z_PARTIAL_FLUSH\r\n});\r\n\r\nconst appServerPath = os.platform() == 'win32' ?\r\n  '\\\\\\\\.\\\\pipe\\\\offlinefirst' + Date.now() + '.sock' :\r\n  'offlinefirst.sock';\r\n\r\nconst connectionProperties = {\r\n  perfect: {bps: 100000000, delay: 0},\r\n  slow: {bps: 4000, delay: 3000},\r\n  'lie-fi': {bps: 1, delay: 10000}\r\n};\r\n\r\nconst imgSizeToFlickrSuffix = {\r\n  '1024px': 'b',\r\n  '800px': 'c',\r\n  '640px': 'z',\r\n  '320px': 'n'\r\n};\r\n\r\nfunction findIndex(arr, func) {\r\n  for (let i = 0; i < arr.length; i++) {\r\n    if (func(arr[i], i, arr)) return i;\r\n  }\r\n  return -1;\r\n}\r\n\r\nexport default class Server {\r\n  constructor(port) {\r\n    this._app = express();\r\n    this._messages = [];\r\n    this._sockets = [];\r\n    this._serverUp = false;\r\n    this._appServerUp = false;\r\n    this._port = port;\r\n    this._connectionType = '';\r\n    this._connections = [];\r\n\r\n    this._appServer = http.createServer(this._app);\r\n    this._exposedServer = net.createServer();\r\n\r\n    this._wss = new WebSocketServer({\r\n      server: this._appServer,\r\n      path: '/updates'\r\n    });\r\n    \r\n    const staticOptions = {\r\n      maxAge: 0\r\n    };\r\n\r\n    this._exposedServer.on('connection', socket => this._onServerConnection(socket));\r\n    this._wss.on('connection', ws => this._onWsConnection(ws));\r\n\r\n    this._app.use(compressor);\r\n    this._app.use('/js', express.static('../public/js', staticOptions));\r\n    this._app.use('/css', express.static('../public/css', staticOptions));\r\n    this._app.use('/imgs', express.static('../public/imgs', staticOptions));\r\n    this._app.use('/avatars', express.static('../public/avatars', staticOptions));\r\n    this._app.use('/sw.js', express.static('../public/sw.js', staticOptions));\r\n    this._app.use('/sw.js.map', express.static('../public/sw.js.map', staticOptions));\r\n    this._app.use('/manifest.json', express.static('../public/manifest.json', staticOptions));\r\n\r\n    this._app.get('/', (req, res) => {\r\n      res.send(indexTemplate({\r\n        scripts: '<script src=\"/js/main.js\" defer></script>',\r\n        content: postsTemplate({\r\n          content: this._messages.map(item => postTemplate(item)).join('')\r\n        })\r\n      }));\r\n    });\r\n\r\n    this._app.get('/skeleton', (req, res) => {\r\n      res.send(indexTemplate({\r\n        scripts: '<script src=\"/js/main.js\" defer></script>',\r\n        content: postsTemplate()\r\n      }));\r\n    });\r\n\r\n    this._app.get('/photos/:farm-:server-:id-:secret-:type.jpg', (req, res) => {\r\n      const flickrUrl = `http://farm${req.params.farm}.staticflickr.com/${req.params.server}/${req.params.id}_${req.params.secret}_${imgSizeToFlickrSuffix[req.params.type]}.jpg`;\r\n      const flickrRequest = http.request(flickrUrl, flickrRes => {\r\n        flickrRes.pipe(res);\r\n      });\r\n\r\n      flickrRequest.on('error', err => {\r\n        // TODO: use a real flickr image as a fallback\r\n        res.sendFile('imgs/icon.png', {\r\n          root: __dirname + '/../public/'\r\n        });\r\n      });\r\n\r\n      flickrRequest.end();\r\n    });\r\n\r\n    this._app.get('/ping', (req, res) => {\r\n      res.set('Access-Control-Allow-Origin', '*');\r\n      res.status(200).send({ok: true});\r\n    });\r\n\r\n    this._app.get('/remote', (req, res) => {\r\n      res.send(remoteExecutorTemplate());\r\n    });\r\n\r\n    this._app.get('/idb-test/', (req, res) => {\r\n      res.send(idbTestTemplate());\r\n    });\r\n\r\n    generateReady.then(_ => {\r\n      // generate initial messages\r\n      let time = new Date();\r\n\r\n      for (let i = 0; i < maxMessages; i++) {\r\n        const msg = generateMessage();\r\n        const timeDiff = random(5000, 15000);\r\n        time = new Date(time - timeDiff);\r\n        msg.time = time.toISOString();\r\n        this._messages.push(msg);\r\n      }\r\n\r\n      this._generateDelayedMessages();\r\n    });\r\n  }\r\n\r\n  _generateDelayedMessages() {\r\n    setTimeout(_ => {\r\n      this._addMessage();\r\n      this._generateDelayedMessages();\r\n    }, random(5000, 15000));\r\n  }\r\n\r\n  _broadcast(obj) {\r\n    const msg = JSON.stringify(obj);\r\n    this._sockets.forEach(socket => socket.send(msg));\r\n  }\r\n\r\n  _onServerConnection(socket) {\r\n    let closed = false;\r\n    this._connections.push(socket);\r\n\r\n    socket.on('close', _ => {\r\n      closed = true;\r\n      this._connections.splice(this._connections.indexOf(socket), 1);\r\n    });\r\n\r\n    socket.on('error', err => console.log(err));\r\n\r\n    const connection = connectionProperties[this._connectionType];\r\n    const makeConnection = _ => {\r\n      if (closed) return;\r\n      const appSocket = net.connect(appServerPath);\r\n      appSocket.on('error', err => console.log(err));\r\n      socket.pipe(new Throttle(connection.bps)).pipe(appSocket);\r\n      appSocket.pipe(new Throttle(connection.bps)).pipe(socket);\r\n    };\r\n\r\n    if (connection.delay) {\r\n      setTimeout(makeConnection, connection.delay);\r\n      return;\r\n    }\r\n    makeConnection();\r\n  }\r\n\r\n  _onWsConnection(socket) {\r\n    const requestUrl = url.parse(socket.upgradeReq.url, true);\r\n\r\n    if ('no-socket' in requestUrl.query) return; \r\n\r\n    this._sockets.push(socket);\r\n\r\n    socket.on('close', _ => {\r\n      this._sockets.splice(this._sockets.indexOf(socket), 1);\r\n    });\r\n\r\n    let sendNow = [];\r\n\r\n    if (requestUrl.query.since) {\r\n      const sinceDate = new Date(Number(requestUrl.query.since));\r\n      let missedMessages = findIndex(this._messages, msg => new Date(msg.time) <= sinceDate);\r\n      if (missedMessages == -1) missedMessages = this._messages.length;\r\n      sendNow = this._messages.slice(0, missedMessages);\r\n    }\r\n    else {\r\n      sendNow = this._messages.slice();\r\n    }\r\n\r\n    if (sendNow.length) {\r\n      socket.send(JSON.stringify(sendNow));\r\n    }\r\n  }\r\n\r\n  _addMessage() {\r\n    const message = generateMessage();\r\n    this._messages.unshift(message);\r\n    this._messages.pop();\r\n    this._broadcast([message]);\r\n  }\r\n\r\n  _listen() {\r\n    this._serverUp = true;\r\n    this._exposedServer.listen(this._port, _ => {\r\n      console.log(\"Server listening at localhost:\" + this._port);\r\n    });\r\n\r\n    if (!this._appServerUp) {\r\n      if (fs.existsSync(appServerPath)) fs.unlinkSync(appServerPath);\r\n      this._appServer.listen(appServerPath);\r\n      this._appServerUp = true;\r\n    }\r\n  }\r\n\r\n  _destroyConnections() {\r\n    this._connections.forEach(c => c.destroy());\r\n  }\r\n\r\n  setConnectionType(type) {\r\n    if (type === this._connectionType) return;\r\n    this._connectionType = type;\r\n    this._destroyConnections();\r\n\r\n    if (type === 'offline') {\r\n      if (!this._serverUp) return;\r\n      this._exposedServer.close();\r\n      this._serverUp = false;\r\n      return;\r\n    }\r\n\r\n    if (!this._serverUp) {\r\n      this._listen();\r\n    }\r\n  }\r\n}"]}